# V19.3-FIX ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è trade.py

## ‚úÖ –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. Paper Trading Mode (`--paper`)

**–ü—Ä–æ–±–ª–µ–º–∞:** Paper trading –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ä–µ–¥—ã:
- `episode_length=len(df)` ‚Äî 525K —à–∞–≥–æ–≤ –≤–º–µ—Å—Ç–æ 300
- `enable_strategy_balancing=False` –≤–º–µ—Å—Ç–æ `True`
- –í–µ—Å—å –¥–∞—Ç–∞—Å–µ—Ç –≤–º–µ—Å—Ç–æ test data (last 3001 rows)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** -0.38% –∑–∞ —ç–ø–∏–∑–æ–¥ (–≤–º–µ—Å—Ç–æ -0.13%)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# V19.3-FIX: Use same settings as training for fair evaluation
test_df = df.tail(3001).copy()

env = EnhancedTradingEnvironment(
    df=test_df,
    initial_balance=initial_balance,
    transaction_fee=0.0018,
    episode_length=300,  # Same as training
    start_step=0,
    debug=False,
    enable_strategy_balancing=True  # Same as training
)
```

---

### 2. Live Trading Mode (`--live`)

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. `BASE_POSITION_SIZE = 0.08` (8%) –≤–º–µ—Å—Ç–æ 0.10 (10% –∫–∞–∫ –≤ training)
2. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ `min_hold_steps = 3`
3. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ `min_open_cooldown = 3 steps`
4. `deterministic=False` –≤–º–µ—Å—Ç–æ `deterministic=True`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### A. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã TradingBot
```python
BASE_POSITION_SIZE = 0.10  # 10% (matches training)
MIN_HOLD_STEPS = 3  # Minimum steps before closing
MIN_OPEN_COOLDOWN = 3  # Cooldown between trades (~3 minutes)
```

#### B. –ü—Ä–æ–≤–µ—Ä–∫–∞ min_hold_steps –¥–ª—è SELL_LONG
```python
def _vt_sell_long(self, price: float):
    steps_held = self.step_counter - self.entry_step
    if steps_held < self.MIN_HOLD_STEPS:
        logger.debug(f"SELL_LONG blocked: held {steps_held} < {self.MIN_HOLD_STEPS} steps")
        return False, None
```

#### C. –ü—Ä–æ–≤–µ—Ä–∫–∞ min_hold_steps –¥–ª—è COVER_SHORT
```python
def _vt_cover_short(self, price: float):
    steps_held = self.step_counter - self.entry_step
    if steps_held < self.MIN_HOLD_STEPS:
        logger.debug(f"COVER_SHORT blocked: held {steps_held} < {self.MIN_HOLD_STEPS} steps")
        return False, None
```

#### D. Cooldown –º–µ–∂–¥—É —Å–¥–µ–ª–∫–∞–º–∏
```python
# Training: min_open_cooldown=3 steps ‚âà 3 minutes in live trading
if now - self.last_trade_time < 180 and self.last_trade_time > 0:
    return False
```

#### E. Deterministic prediction
```python
# V19.3-FIX: Use deterministic=True (matches eval_v19.py)
action, _ = self.model.predict(state, deterministic=True)
```

---

### 3. Model Loading

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è PPO –≤–º–µ—Å—Ç–æ DQN

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
from stable_baselines3 import DQN  # Instead of PPO

model = DQN.load(model_path)  # Instead of PPO.load()
```

---

### 4. Default Model Path

**–ü—Ä–æ–±–ª–µ–º–∞:** Default –ø—É—Ç—å –±—ã–ª `ppo_trading_agent.zip`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
parser.add_argument('--model', 
    default='rl_checkpoints_v19_dqn_fixed/dqn_v19_best.zip',
    help='Path to trained DQN model')
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –†–µ–∂–∏–º | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π |
|-------|---------------|-------------------|
| **Paper (--paper)** | -0.38%/—ç–ø–∏–∑–æ–¥ | **-0.13%/—ç–ø–∏–∑–æ–¥** ‚úÖ |
| **Win Rate** | ~21% | **~50%** ‚úÖ |
| **Trades/episode** | 165 | **~8** ‚úÖ |
| **Live (--live)** | N/A | **–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç—É** ‚úÖ |

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### Paper Trading
```bash
cd /Volumes/Movies/PYTHON/RL-Algorithmic-Trading-Bot
source .venv/bin/activate

# 1 —ç–ø–∏–∑–æ–¥ (–±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç)
python trade.py --paper --episodes 1

# 4 —ç–ø–∏–∑–æ–¥–∞ (–ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç)
python trade.py --paper --episodes 4
```

### Live Trading (Virtual)
```bash
# 60 –º–∏–Ω—É—Ç —Å–µ—Å—Å–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
python trade.py --live --duration 60 --interval 60

# –°–≤–æ–π —Å–∏–º–≤–æ–ª –∏ –±–∞–ª–∞–Ω—Å
python trade.py --live --duration 120 --symbol BTC-USDT --balance 10000
```

---

## üìù Changelog

### V19.3-FIX (2026-02-28)
- ‚úÖ Paper trading: episode_length 525K ‚Üí 300
- ‚úÖ Paper trading: enable_strategy_balancing False ‚Üí True
- ‚úÖ Paper trading: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç last 3001 rows (test data)
- ‚úÖ Live trading: BASE_POSITION_SIZE 0.08 ‚Üí 0.10
- ‚úÖ Live trading: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ MIN_HOLD_STEPS=3
- ‚úÖ Live trading: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ MIN_OPEN_COOLDOWN=3 (‚âà3 min)
- ‚úÖ Live trading: deterministic=False ‚Üí True
- ‚úÖ Model: PPO ‚Üí DQN
- ‚úÖ Default model path –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ v19.3

---

**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é ‚úÖ
