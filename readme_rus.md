# Полный запуск с LSTM
python pipeline.py

# RL обучение
python pipeline.py --rl --start-from 4

# Оценка RL агента
python train_rl.py --eval


# Алгоритмическая торговля Bitcoin с использованием LSTM и Pytorch
Это мой небольшой проект, который я создал, потому что меня интересовала алгоритмическая торговля и машинное обучение.
По сути, он использует нейронную сеть LSTM для предсказания цены биткоина. Затем он использует предсказанную цену плюс некоторые индикаторы, чтобы решить, покупать или продавать биткоин.
Этот бот предназначен для торговли одной конкретной валютной парой для простоты.

Цель всего этого проекта - изучить конвейеры данных, науку о данных, машинное обучение и алгоритмическую торговлю. Это чисто в образовательных целях.

## Требования
Рекомендуется Python 3.11. Не уверен, работает ли с более низкими версиями Python.
Сначала установите требования с помощью `pip install -r requirements.txt`. Это установит все необходимые пакеты.

Затем вы должны вручную установить `TA_Lib-0.4.24`. Это библиотека технического анализа, которую я использовал для ключевой части бота.
Вы также должны вручную установить правильную версию `pytorch` для вашей системы. Вы можете найти правильную версию здесь: https://pytorch.org/get-started/locally/.

## Использование
1. Получите данные секунда за секундой из Binance с помощью `get_new_dataset.bat`. Это пакетный файл, который запустит несколько скриптов Python для получения, очистки и инженерии признаков данных.
Эти данные хранятся в CSV-файле в папке с именем `btc_usdt_data`. Переименуйте эту папку в `btc_usdt_training_data`. Сделайте это еще 2 раза и переименуйте папки в `trading_alg_tuning_data` и `paper_trade_data`.

Возможно, вам придется скорректировать период времени в `get_price_data.py`, чтобы получить правильное количество данных. Я использовал 3 месяца данных для обучения, ~1 неделю для настройки параметров и около 3 недель для бумажной торговли. Для контекста, мой компьютер имеет 32 Гб ОЗУ и GPU 3070 ti. Обучение на 4 месяцах данных едва помещается в память.

2. Обучите нейронную сеть LSTM с помощью `train_model.py`. В конце он создаст файл с именем `lstm_model_{MSE}.pt`, где `{MSE}` - среднеквадратичная ошибка модели. Этот файл будет использоваться ботом для предсказания цен.

3. Здесь я использовал немного ручной работы для настройки параметров алгоритма торговли. `strategy_tuning.py` используется для тестирования разных параметров и определения лучших на основе коэффициента Шарпа. Возможно, вам придется скорректировать безрисковую ставку для расчета правильного коэффициента Шарпа. Это выведет в консоль топ-10 параметров на основе коэффициента Шарпа, вместе с прибылью и максимальной просадкой. Также выводится график стоимости портфеля топ-10 параметров по времени. Затем вы можете продолжить поиск и выбрать свой любимый и использовать его на следующем шаге в `paper_trading.py`. (Или полностью игнорировать этот шаг и использовать параметры, которые я использовал, параметры могут не быть лучшими для всех наборов данных).

4. Запустите `paper_trading.py`, чтобы увидеть, как алгоритм работает на невидимых данных. Это создаст файл с именем `lstm_vs_buy_and_hold.png`, который показывает стоимость портфеля алгоритма по сравнению с покупкой и удержанием. Вы можете увидеть результаты теста там. В консоли печатаются коэффициент Шарпа и максимальная просадка.

## Подробности о каждом файле
`get_new_dataset.bat`: Запускает скрипты Python для получения данных из Binance, их очистки и инженерии признаков.

`get_price_data.py`: Получает данные о ценах из Binance и сохраняет их в CSV-файл. Он специально получает данные для BTC/USDT с разрешением 1 секунда. Вы можете изменить пару и разрешение данных. Проверьте документацию API Binance для дополнительной информации.

`clean_data.py`: Очищает данные. Строки с отсутствующими данными и бесполезные столбцы. Затем сохраняет данные в CSV-файл.

`feature_engineering.py`: Добавляет признаки к данным. Он добавляет EMA, BB, RSI, ULTOSC, OBV, AD, ATR, WCLPRICE, HT_DCPERIOD, VAR и MFI для 3 разных периодов времени (если применимо). Затем сохраняет данные в CSV-файл.

`train_model.py`: Обучает нейронную сеть LSTM. Он будет использовать поиск гиперпараметров для нахождения лучших параметров для модели. Он использует данные в `btc_usdt_training_data` для обучения модели. Затем он сохранит модель в файл с именем `lstm_model_{MSE}.pt`, где `{MSE}` - среднеквадратичная ошибка модели на подмножестве `btc_usdt_training_data`. 

`strategy_tuning.py`: Тестирует разные параметры для алгоритма торговли. Использует симулированную торговую среду для тестирования параметров, как можно более реалистично. Он будет использовать данные в `trading_alg_tuning_data` для тестирования алгоритма. Затем он напечатает топ-10 параметров на основе коэффициента Шарпа, вместе с прибылью и максимальной просадкой. Также выводится график стоимости портфеля топ-10 параметров по времени.

`paper_trading.py`: Тестирует алгоритм на невидимых данных в аналогичной торговой среде. Он будет использовать данные в `paper_trade_data` для тестирования алгоритма. Затем он напечатает коэффициент Шарпа и максимальную просадку алгоритма. Также выведет график стоимости портфеля по времени.

## Мои результаты
Итак, я использовал данные с 1 октября 2023 года до конца 17 декабря 2023 года для обучения. 18 декабря по 26 декабря для настройки параметров. 27 декабря по 17 января для бумажной торговли. 

Моя оптимальная модель имела MSE 1472, что заняло около недели на обучение и настройку. В итоге это была 4-слойная LSTM с 1 финальным линейным выходным слоем. Она имеет 512 скрытых единиц на слой, используя скорость обучения 0.01, размер пакета 192.

Настройка алгоритмического торгового бота также заняла около другой недели для тонкой настройки. Я сделал это дважды, потому что результат, который я получил в первый раз, не соответствовал моим ожиданиям.
Ниже приведен график 10 случайных гиперпараметров.
![tuning results](./tuning_strategy.png)

В конце концов, мне удалось настроить результаты намного точнее. Ниже показан график топ-10 гиперпараметров в финальном раунде настройки.
![tuning results part 2](./tuning_strategy_results.png)

Он имел чистую прибыль +189.02 или 1.89%, коэффициент Шарпа 0.0343 и максимальную просадку -1.26% за тестовый период. 
По сравнению с простой стратегией покупки и удержания, которая фактически потеряла немного денег за тестовый период с убытком -0.25%.

Эта настройка была сделана в среде, предполагающей торговую комиссию 0.18% за сделку. Это комиссия, которую Binance взимает за спотовую торговлю с очень высоким объемом.
Я также вывел безрисковую ставку 0.0006811% за 1000 секунд из доходности 3-месячного казначейского векселя США.

Бумажная торговля была протестирована в аналогичной среде с оптимальными параметрами, найденными ранее. 
![Paper trading results](./lstm_vs_buy_and_hold_normal.png)

Алгоритмический торговый бот имел чистую прибыль 2.702% и коэффициент Шарпа 0.0222 и максимальную просадку 0.613% за период бумажной торговли.
Стратегия покупки и удержания имела чистую прибыль 0.68% и коэффициент Шарпа 0.000684 и максимальную просадку -14.21% за период бумажной торговли.

### Дальнейшее тестирование

Итак, давайте попробуем протестировать алгоритмический торговый бот на бычьем рынке и медвежьем рынке. Я буду использовать те же параметры, что и раньше.
(Бычий рынок, 11 марта 2023 года по 18 марта 2023 года)
![Paper trading results in bull market](./lstm_vs_buy_and_hold_bull.png)

Так себе результаты для бычьего рынка. Он заработал вдвое меньше, чем просто покупка и удержание! Тем не менее, имеет более низкую просадку и более высокий коэффициент Шарпа. Можно сказать, лучшее управление рисками.
LSTM        : Чистая прибыль: 16.81%, Коэффициент Шарпа: 0.0659851, Максимальная просадка: -0.06478%
Покупка и удержание: Чистая прибыль: 32.96%, Коэффициент Шарпа: 0.0084906, Максимальная просадка: -0.08566%

(Медвежий рынок, 6 мая 2021 года по 21 мая 2021 года)
![Paper trading results in bear market](./lstm_vs_buy_and_hold_bear.png)
Гораздо лучшие результаты здесь для медвежьего рынка. Он очень хорош в сохранении богатства. Он имеет значительно более низкую просадку и более высокий коэффициент Шарпа, чем покупка и удержание!
Эти спады - где бот сияет. Он способен избегать больших потерь и поддерживать последовательную производительность.

LSTM        : Чистая прибыль: -0.18%, Коэффициент Шарпа: -0.0011961, Максимальная просадка: -0.09947%
Покупка и удержание: Чистая прибыль: -33.88%, Коэффициент Шарпа: -0.0357828, Максимальная просадка: -0.43565%

## Выводы

### Чистая прибыль
Алгоритмический торговый бот превзошел стратегию покупки и удержания в терминах чистой прибыли, коэффициента Шарпа и максимальной просадки.
Сравнивая чистую прибыль, торговый бот сделал в 4 раза больше прибыли, чем стратегия покупки и удержания! Это, конечно, означает, что бот намного прибыльнее, чем стратегия покупки и удержания, и он может генерировать больше доходов за торговый период.

### Коэффициент Шарпа
Коэффициент Шарпа - это мера доходности с поправкой на риск. Коэффициент Шарпа бота 0.0222 значительно выше, чем коэффициент Шарпа стратегии покупки и удержания 0.000684. Это означает, что бот имеет более эффективную стратегию управления рисками. Он способен генерировать больше доходов на единицу риска, чем стратегия покупки и удержания.

### Максимальная просадка
Максимальная просадка - это мера наибольшего падения стоимости портфеля от пика до впадины. Максимальная просадка бота 0.613% значительно ниже, чем максимальная просадка стратегии покупки и удержания -14.21%. Это означает, что бот способен лучше управлять рисками и избегать больших потерь.

### Общее управление рисками
Комбинация более высокого коэффициента Шарпа и намного более низкой максимальной просадки означает, что бот не только намного прибыльнее, чем покупка и удержание, но и управлял рисками более эффективно. Смотря на график стоимости портфеля по времени, мы можем видеть, что бот способен избегать больших падений цен (наиболее заметно около отметок 600 и 1400). Однако, кажется, он упускает некоторые большие скачки стоимости, которые стратегия покупки и удержания смогла захватить (а затем потерять). Бот, кажется, поддерживал более последовательную производительность с меньшей волатильностью и меньшими потерями.

Вот результаты еще раз.
![Paper trading results again](./lstm_vs_buy_and_hold.png)

### Период времени, рыночный контекст и реальное применение
Эти числа показывают превосходство бота в протестированном конкретном периоде времени. Однако, эти числа основаны на довольно упрощенной торговой среде и не учитывают проскальзывание и рыночное влияние больших ордеров, а также разные периоды времени. Возможно, этот торговый бот не работает хорошо на реальных рынках, но это нормально для этого проекта. Это могло бы быть вещи, которые я учту и улучшу в будущем. Может быть, я мог бы научиться моделировать проскальзывание.

Цель этого проекта была изучить алгоритмическую торговлю и машинное обучение. Я узнал много о обеих этих темах и доволен результатами этого проекта!
